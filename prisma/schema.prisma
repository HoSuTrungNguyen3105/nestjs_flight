generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"] // <--- Add this line
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  // The `url` property has been removed from schema files in Prisma v7.
  // Configure your connection URL and migration settings in prisma.config.ts
  // and pass `adapter` (for direct DB) or `accelerateUrl` (for Accelerate) to the PrismaClient constructor.
  // See: https://pris.ly/d/config-datasource and https://pris.ly/d/prisma7-client-config
}

model User {
  id                      Int             @id @default(autoincrement())
  email                   String          @unique
  name                    String          @db.VarChar(50)
  role                    Role            @default(ADMIN)
  password                String          @db.VarChar(100)
  pictureUrl              String          @default("")
  rank                    Rank            @default(NONE)
  authType                String          @default("ID,PW")
  prevPassword            String          @default("")
  isEmailVerified         String          @default("N")
  userAlias               String          @default("")
  createdAt               Decimal         @db.Decimal(20, 3)
  updatedAt               Decimal         @db.Decimal(20, 3)
  accountLockYn           String          @default("N")
  lastLoginDate           Decimal?        @db.Decimal(20, 3)
  loginFailCnt            Int             @default(0)
  mfaEnabledYn            String          @default("N")
  mfaSecretKey            String?         @default("")
  tempPassword            String?
  resetTokenExpires       Decimal?        @db.Decimal(20, 3)
  resetToken              String?
  phone                   String          @default("")
  otpCode                 String?
  otpExpire               Decimal?        @db.Decimal(20, 3)
  baseSalary              Float?
  department              Department?
  employeeNo              String?         @unique
  hireDate                Decimal?        @db.Decimal(20, 3)
  position                Position?
  status                  EmployeeStatus  @default(ACTIVE)
  fromTransferAdminUserYn String?         @default("N")
  toTransferAdminUserYn   String?         @default("N")
  isDeleted               Boolean         @default(false)
  attendance              Attendance[]
  leaveRequest            LeaveRequest[]
  receivedMessages        Message[]       @relation("ReceivedMessages")
  sentMessages            Message[]       @relation("SentMessages")
  payrolls                Payroll[]
  transferAdmin           TransferAdmin?
  unlockRequests          UnlockRequest[]
  sessions                UserSession[]
  notifications           Notification[]
  bookingLogs             BookingLog[]
  assignedTickets         SupportTicket[] @relation("AssignedSupportTickets")
  supportTickets          SupportTicket[] @relation("UserSupportTickets")
  // rolePermissions         RolePermission[]
  // userPermissions         UserPermission[]
}

model RolePermission {
  id          String @id @default(uuid())
  role        Role   @unique
  permissions Json

  createdAt Decimal @db.Decimal(20, 3)
  updatedAt Decimal @db.Decimal(20, 3)
  // user        User?      @relation(fields: [userId], references: [id])
  // userId      Int?
  // passenger   Passenger? @relation(fields: [passengerId], references: [id])
  // passengerId String?
}

// model UserPermission {
//   id          String  @id @default(uuid())
//   userId      Int?    @unique
//   passengerId String? @unique
//   permissions Json

//   createdAt Decimal @db.Decimal(20, 3)
//   updatedAt Decimal @db.Decimal(20, 3)

//   user      User?      @relation(fields: [userId], references: [id])
//   passenger Passenger? @relation(fields: [passengerId], references: [id])
// }

model TransferAdmin {
  id          Int            @id @default(autoincrement())
  userId      Int            @unique
  fromUserId  Int
  toUserId    Int
  status      TransferStatus @default(PENDING)
  requestedAt Decimal        @db.Decimal(20, 3)
  approvedAt  Decimal?       @db.Decimal(20, 3)
  user        User           @relation(fields: [userId], references: [id])
}

model Message {
  id         Int     @id @default(autoincrement())
  content    String  @db.VarChar(100)
  createdAt  Decimal @db.Decimal(20, 3)
  senderId   Int
  receiverId Int
  receiver   User    @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User    @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
}

model UserSession {
  id          Int        @id @default(autoincrement())
  userId      Int?
  token       String     @db.Text
  createdAt   Decimal?   @db.Decimal(20, 3)
  browser     String?
  device      String?
  ipAddress   String?
  isCurrent   Boolean    @default(false)
  location    String?
  userAgent   String?
  passengerId String?
  passenger   Passenger? @relation(fields: [passengerId], references: [id], onDelete: Cascade)
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "UserSession_userId_fkey")
  @@index([passengerId], map: "UserSession_passengerId_fkey")
}

model Passenger {
  id              String          @id @default(cuid())
  fullName        String
  email           String          @unique
  phone           String
  passport        String
  accountLockYn   String          @default("N")
  isEmailVerified String          @default("Y")
  lastLoginDate   Decimal?        @db.Decimal(20, 3)
  password        String?         @db.VarChar(100)
  status          EmployeeStatus  @default(ACTIVE)
  otpCode         String?
  otpExpire       Decimal?        @db.Decimal(20, 3)
  role            Role            @default(PASSENGER)
  loginFailCnt    Int             @default(0)
  mfaEnabledYn    String          @default("N")
  mfaSecretKey    String?         @default("")
  bookings        Booking[]
  reviews         HotelReview[]
  tickets         Ticket[]
  sessions        UserSession[]
  notifications   Notification[]
  supportTickets  SupportTicket[]
  // rolePermissions RolePermission[]
  // userPermission  UserPermission?
}

model Payroll {
  id          Int           @id @default(autoincrement())
  employeeId  Int
  month       Int
  year        Int
  baseSalary  Float
  allowances  Float         @default(0)
  deductions  Float         @default(0)
  tax         Float         @default(0)
  netPay      Float
  status      PayrollStatus @default(DRAFT)
  generatedAt Decimal       @db.Decimal(20, 3)
  employee    User          @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
  @@index([employeeId])
}

model Attendance {
  id          Int              @id @default(autoincrement())
  employeeId  Int
  date        Decimal          @db.Decimal(20, 3)
  checkIn     Decimal          @db.Decimal(20, 3)
  checkOut    Decimal          @db.Decimal(20, 3)
  status      AttendanceStatus @default(PRESENT)
  workedHours Float?
  note        String?
  createdAt   Decimal          @db.Decimal(20, 3)
  employee    User             @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
  @@index([employeeId])
}

model LeaveRequest {
  id           Int         @id @default(autoincrement())
  employeeId   Int
  leaveType    String
  startDate    Decimal     @db.Decimal(20, 3)
  endDate      Decimal     @db.Decimal(20, 3)
  days         Float
  reason       String?
  status       LeaveStatus @default(PENDING)
  approverId   Int?
  approverNote String?
  appliedAt    Decimal     @db.Decimal(20, 3)
  decidedAt    Decimal?    @db.Decimal(20, 3)
  employee     User        @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model UnlockRequest {
  id         Int          @id @default(autoincrement())
  reason     String       @db.Text
  status     UnlockStatus @default(PENDING)
  createdAt  Decimal      @db.Decimal(20, 3)
  approvedAt Decimal?     @db.Decimal(20, 3)
  employeeId Int
  user       User         @relation(fields: [employeeId], references: [id])

  @@index([employeeId], map: "UnlockRequest_employeeId_fkey")
}

model Flight {
  flightId            Int              @id @default(autoincrement())
  flightNo            String           @unique @db.VarChar(10)
  departureAirport    String           @db.VarChar(10)
  arrivalAirport      String           @db.VarChar(10)
  aircraftCode        String           @db.VarChar(10)
  scheduledDeparture  Decimal          @db.Decimal(20, 3)
  scheduledArrival    Decimal          @db.Decimal(20, 3)
  actualDeparture     Decimal?         @db.Decimal(20, 3)
  actualArrival       Decimal?         @db.Decimal(20, 3)
  flightType          FlightType       @default(oneway)
  priceBusiness       Float?
  priceEconomy        Float?
  priceFirst          Float?
  gateId              String?          @unique
  isDomestic          Boolean          @default(true)
  baggage             Baggage[]
  boardingPasses      BoardingPass[]
  bookings            Booking[]
  aircraft            Aircraft         @relation(fields: [aircraftCode], references: [code])
  arrivalAirportRel   Airport          @relation("ArrivalRelation", fields: [arrivalAirport], references: [code])
  departureAirportRel Airport          @relation("DepartureRelation", fields: [departureAirport], references: [code])
  gate                Gate?            @relation(fields: [gateId], references: [id])
  discounts           FlightDiscount[]
  meals               FlightMeal[]
  flightStatuses      FlightStatus[]
  gateAssignments     GateAssignment[]
  seats               Seat[]
  tickets             Ticket[]

  @@index([aircraftCode], map: "Flight_aircraftCode_fkey")
  @@index([arrivalAirport], map: "Flight_arrivalAirport_fkey")
  @@index([departureAirport], map: "Flight_departureAirport_fkey")
  @@index([gateId])
}

model Aircraft {
  code          String   @id
  model         String
  imageAircraft String?
  range         Int
  manufacturer  String? // Airbus / Boeing
  totalSeats    Int?
  flights       Flight[]
}

model Airport {
  code       String     @id
  name       String
  city       String
  country    String
  createdAt  Decimal    @db.Decimal(20, 3)
  updatedAt  Decimal?   @db.Decimal(20, 3)
  arrivals   Flight[]   @relation("ArrivalRelation")
  departures Flight[]   @relation("DepartureRelation")
  terminals  Terminal[]
}

model Booking {
  id             Int             @id @default(autoincrement())
  passengerId    String
  flightId       Int
  bookingTime    Decimal         @db.Decimal(20, 3)
  bookingCode    String?         @unique
  seatClass      SeatType        @default(ECONOMY)
  seatNo         String          @default("N/A") @db.VarChar(10)
  seatPrice      Decimal?        @db.Decimal(10, 2)
  status         BookingStatus   @default(PENDING)
  seatId         Int
  flight         Flight          @relation(fields: [flightId], references: [flightId])
  passenger      Passenger       @relation(fields: [passengerId], references: [id])
  seat           Seat            @relation(fields: [seatId], references: [id])
  mealOrders     MealOrder[]
  tickets        Ticket[]        @relation("BookingToTicket")
  bookingLogs    BookingLog[]
  supportTickets SupportTicket[]

  @@index([flightId])
  @@index([passengerId])
  @@index([seatId], map: "Booking_seatId_fkey")
}

model Ticket {
  id           Int           @id @default(autoincrement())
  ticketNo     String        @unique
  passengerId  String
  flightId     Int
  qrCodeImage  String?       @db.Text
  bookingId    Int?
  baggage      Baggage?
  boardingPass BoardingPass?
  payments     Payment[]
  booking      Booking?      @relation("BookingToTicket", fields: [bookingId], references: [id])
  flight       Flight        @relation(fields: [flightId], references: [flightId])
  passenger    Passenger     @relation(fields: [passengerId], references: [id])

  @@index([bookingId])
  @@index([passengerId])
  @@index([flightId])
}

model BoardingPass {
  id       Int            @id @default(autoincrement())
  ticketId Int            @unique
  issuedAt Decimal        @db.Decimal(20, 3)
  flightId Int
  status   BoardingStatus @default(PENDING)
  gateId   String
  flight   Flight         @relation(fields: [flightId], references: [flightId])
  gate     Gate           @relation(fields: [gateId], references: [id])
  ticket   Ticket         @relation(fields: [ticketId], references: [id])

  @@index([flightId], map: "BoardingPass_flightId_fkey")
  @@index([gateId], map: "BoardingPass_gateId_fkey")
}

model Baggage {
  id        Int     @id @default(autoincrement())
  flightId  Int
  weight    Float
  status    String  @db.VarChar(20)
  checkedAt Decimal @db.Decimal(20, 3)
  ticketId  Int     @unique
  flight    Flight  @relation(fields: [flightId], references: [flightId])
  ticket    Ticket  @relation(fields: [ticketId], references: [id])

  @@index([flightId], map: "Baggage_flightId_fkey")
}

model Meal {
  id          Int          @id @default(autoincrement())
  name        String
  mealType    MealType
  description String?
  price       Float?
  mealCode    String?      @unique
  isAvailable Boolean      @default(true)
  flightMeals FlightMeal[]
  // mealOrders  MealOrder[]
}

model Seat {
  id                   Int       @id @default(autoincrement())
  flightId             Int
  seatNumber           Int
  seatRow              String
  isBooked             Boolean   @default(false)
  isAvailable          Boolean   @default(true)
  isExitRow            Boolean   @default(false)
  isExtraLegroom       Boolean   @default(false)
  note                 String?
  price                Float?
  isHandicapAccessible Boolean   @default(false)
  isNearLavatory       Boolean   @default(false)
  isUpperDeck          Boolean   @default(false)
  isWing               Boolean   @default(false)
  //type                 SeatType  @default(ECONOMY)
  bookings             Booking[]
  flight               Flight    @relation(fields: [flightId], references: [flightId])

  @@index([flightId], map: "Seat_flightId_fkey")
}

model FlightDiscount {
  id             Int          @id @default(autoincrement())
  discountCodeId Int
  flightId       Int
  createdAt      Decimal      @db.Decimal(20, 3)
  discountCode   DiscountCode @relation(fields: [discountCodeId], references: [id])
  flight         Flight       @relation(fields: [flightId], references: [flightId])

  @@unique([discountCodeId, flightId])
  @@index([flightId], map: "FlightDiscount_flightId_fkey")
}

model DiscountCode {
  id              Int              @id @default(autoincrement())
  code            String           @unique
  description     String?
  discountAmount  Decimal?
  discountPercent Int?
  isPercentage    Boolean          @default(false)
  active          Boolean          @default(true)
  usageLimit      Int?
  usedCount       Int              @default(0)
  validFrom       Decimal          @db.Decimal(20, 3)
  validTo         Decimal          @db.Decimal(20, 3)
  createdAt       Decimal          @db.Decimal(20, 3)
  updatedAt       Decimal          @db.Decimal(20, 3)
  flights         FlightDiscount[]
}

model Facility {
  id           String       @id @default(cuid())
  name         String
  type         FacilityType
  description  String?
  terminalId   String
  location     String?
  openingHours String?
  createdAt    Decimal      @db.Decimal(20, 3)
  updatedAt    Decimal      @db.Decimal(20, 3)
  terminal     Terminal     @relation(fields: [terminalId], references: [id], onDelete: Cascade)

  @@index([terminalId], map: "Facility_terminalId_fkey")
}

model Terminal {
  id          String       @id @default(cuid())
  code        String       @unique
  name        String
  description String?
  type        TerminalType
  airportId   String
  createdAt   Decimal      @db.Decimal(20, 3)
  updatedAt   Decimal      @db.Decimal(20, 3)
  facilities  Facility[]
  gates       Gate[]
  airport     Airport      @relation(fields: [airportId], references: [code], onDelete: Cascade)

  @@unique([airportId, code])
}

model GateAssignment {
  id         String  @id @default(cuid())
  gateId     String
  flightId   Int
  assignedAt Decimal @db.Decimal(20, 3)
  releasedAt Decimal @db.Decimal(20, 3)
  createdAt  Decimal @db.Decimal(20, 3)
  updatedAt  Decimal @db.Decimal(20, 3)
  flight     Flight  @relation(fields: [flightId], references: [flightId], onDelete: Cascade)
  gate       Gate    @relation(fields: [gateId], references: [id], onDelete: Cascade)

  @@unique([gateId, flightId])
  @@index([flightId], map: "GateAssignment_flightId_fkey")
}

model Gate {
  id             String           @id @default(cuid())
  code           String           @unique
  terminalId     String
  status         GateStatus       @default(AVAILABLE)
  createdAt      Decimal          @db.Decimal(20, 3)
  updatedAt      Decimal          @db.Decimal(20, 3)
  boardingPasses BoardingPass[]
  currentFlight  Flight?
  terminal       Terminal         @relation(fields: [terminalId], references: [id], onDelete: Cascade)
  assignments    GateAssignment[]

  @@unique([terminalId, code])
}

model Notification {
  id          Int     @id @default(autoincrement())
  passengerId String? // Target Passenger
  userId      Int? // Target User (Admin/Monitor) - optional if you want unified notifications
  title       String
  message     String  @db.Text
  type        String // e.g., "BOOKING_UPDATE", "PROMOTION", "SYSTEM"
  isRead      Boolean @default(false)
  createdAt   Decimal @db.Decimal(20, 3)

  passenger Passenger? @relation(fields: [passengerId], references: [id])
  user      User?      @relation(fields: [userId], references: [id])

  @@index([passengerId])
  @@index([userId])
}

model SupportTicket {
  id          Int          @id @default(autoincrement())
  passengerId String
  bookingId   Int?
  subject     String
  description String       @db.Text
  status      TicketStatus @default(OPEN) // Enum: OPEN, IN_PROGRESS, RESOLVED, CLOSED
  assignedTo  Int? // Monitor/Admin ID handling this
  createdAt   Decimal      @db.Decimal(20, 3)
  updatedAt   Decimal      @db.Decimal(20, 3)

  passenger Passenger @relation(fields: [passengerId], references: [id])
  booking   Booking?  @relation(fields: [bookingId], references: [id])
  assignee  User?     @relation("AssignedSupportTickets", fields: [assignedTo], references: [id])
  user      User?     @relation("UserSupportTickets", fields: [userId], references: [id])
  userId    Int?

  @@index([passengerId])
  @@index([assignedTo])
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model FlightMeal {
  id             Int         @id @default(autoincrement())
  flightMealCode String?     @unique
  flightId       Int
  mealId         Int
  quantity       Int         @default(1)
  price          Float?
  flight         Flight      @relation(fields: [flightId], references: [flightId])
  meal           Meal        @relation(fields: [mealId], references: [id])
  mealOrders     MealOrder[]

  @@index([flightId], map: "FlightMeal_flightId_fkey")
  @@index([mealId], map: "FlightMeal_mealId_fkey")
}

model MealOrder {
  id           Int        @id @default(autoincrement())
  bookingId    Int
  flightMealId Int
  quantity     Int        @default(1)
  booking      Booking    @relation(fields: [bookingId], references: [id])
  flightMeal   FlightMeal @relation(fields: [flightMealId], references: [id])

  @@index([bookingId], map: "MealOrder_bookingId_fkey")
  @@index([flightMealId], map: "MealOrder_flightMealId_fkey")
}

model FlightStatus {
  id          Int              @id @default(autoincrement())
  flightId    Int
  status      FlightStatusType @default(SCHEDULED)
  description String?          @db.VarChar(255)
  updatedAt   Decimal          @db.Decimal(20, 3)
  flight      Flight           @relation(fields: [flightId], references: [flightId])

  @@index([flightId], map: "FlightStatus_flightId_fkey")
}

model Hotel {
  id               Int           @id @default(autoincrement())
  name             String
  city             String
  address          String
  rating           Float
  reviewCount      Int           @default(0)
  distanceToCenter Float
  imageUrl         String
  price            Float
  discountPercent  Float?
  isPrime          Boolean       @default(false)
  freeWifi         Boolean       @default(false)
  covidMeasures    Boolean       @default(false)
  freeCancel       Boolean       @default(false)
  payLater         Boolean       @default(false)
  rooms            Int           @default(0)
  createdAt        Decimal       @db.Decimal(20, 3)
  updatedAt        Decimal       @db.Decimal(20, 3)
  hotelCode        String?       @unique
  externalId       String?
  externalSource   String?
  isImported       Boolean       @default(false)
  reviews          HotelReview[]
}

model HotelReview {
  id          Int       @id @default(autoincrement())
  passengerId String
  hotelId     Int
  rating      Float
  comment     String?
  createdAt   DateTime  @default(now())
  hotel       Hotel     @relation(fields: [hotelId], references: [id])
  passenger   Passenger @relation(fields: [passengerId], references: [id])

  @@index([hotelId], map: "HotelReview_hotelId_fkey")
  @@index([passengerId], map: "HotelReview_passengerId_fkey")
}

model Payment {
  id            Int           @id @default(autoincrement())
  ticketId      Int
  amount        Decimal       @db.Decimal(20, 3)
  currency      String        @default("VND")
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique
  paymentUrl    String?
  createdAt     Decimal       @default(dbgenerated("(unix_timestamp() * 1000)")) @db.Decimal(20, 3)
  updatedAt     Decimal       @db.Decimal(20, 3)
  ticket        Ticket        @relation(fields: [ticketId], references: [id])

  @@index([ticketId], map: "Payment_ticketId_fkey")
}

model BookingLog {
  id             Int            @id @default(autoincrement())
  bookingId      Int
  action         String // e.g., "CANCEL_BOOKING", "UPGRADE_SEAT", "REFUND"
  previousStatus BookingStatus? // Snapshot of status before change
  newStatus      BookingStatus? // Status after change
  changedById    Int? // The Admin or Monitor who made the change
  reason         String?        @db.Text // Reason for the action (e.g., "Customer request", "Payment failed")
  createdAt      Decimal        @db.Decimal(20, 3)

  booking   Booking @relation(fields: [bookingId], references: [id])
  changedBy User?   @relation(fields: [changedById], references: [id]) // Relation to Admin/Monitor

  @@index([bookingId])
  @@index([changedById])
}

enum PaymentMethod {
  MOMO
  ZALOPAY
  STRIPE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

enum Role {
  PASSENGER
  ADMIN
  MONITOR
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum UnlockStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BoardingStatus {
  PENDING
  BOARDED
  EXPIRED
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TERMINATED
}

enum FlightType {
  roundtrip
  oneway
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  ON_LEAVE
  REMOTE
}

enum PayrollStatus {
  DRAFT
  FINALIZED
  PAID
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  PAID
}

enum Department {
  HR
  IT
  FINANCE
  OPS
  SECURITY
  OTHER
}

enum Position {
  INTERN
  STAFF
  SENIOR
  MANAGER
  DIRECTOR
  EXECUTIVE
}

enum Rank {
  JUNIOR
  MID
  SENIOR
  LEAD
  PRINCIPAL
  NONE
}

enum TerminalType {
  INTERNATIONAL
  DOMESTIC
  BUSINESS
}

enum GateStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  CLOSED
}

enum FacilityType {
  RESTAURANT
  SHOP
  LOUNGE
  INFORMATION
  SECURITY
  TRANSPORTATION
  OTHER
}

enum SeatType {
  VIP
  BUSINESS
  ECONOMY
  FIRST
}

enum MealType {
  VEG
  NONVEG
  DRINK
  DESSERT
  BEVERAGE
  SNACK
  DINNER
  LUNCH
  BREAKFAST
}

enum TransferStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FlightStatusType {
  SCHEDULED
  BOARDING
  DELAYED
  DEPARTED
  ARRIVED
  CANCELLED
  IN_AIR
  COMPLETED
}
