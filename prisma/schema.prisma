generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  MONITOR
}

model User {
  id         Int     @id @default(autoincrement())
  email      String  @unique
  name       String  @db.VarChar(50) // ho·∫∑c firstname + lastname
  pictureUrl String  @default("")
  rank       String  @default("")
  role       Role    @default(USER)
  password   String  @db.VarChar(100)
  createdAt  Decimal @db.Decimal(20, 3)
  updatedAt  Decimal @db.Decimal(20, 3)
  userAlias  String

  // Auth
  authType      String  @default("ID,PW")
  loginFailCnt  Int     @default(0)
  accountLockYn String  @default("N")
  mfaEnabledYn  String  @default("N")
  mfaSecretKey  String? // L∆∞u secret Google Authenticator

  tempPassword    String? // L∆∞u m·∫≠t kh·∫©u t·∫°m th·ªùi khi reset
  isEmailVerified String  @default("N")

  // L·ªãch s·ª≠ m·∫≠t kh·∫©u (n·∫øu c·∫ßn)
  prevPassword String @default("")

  // Ho·∫°t ƒë·ªông g·∫ßn nh·∫•t
  lastLoginDate Decimal? @db.Decimal(20, 3)

  // Transfer admin (gom nh√≥m)
  transferAdmin   TransferAdmin?
  transferAdminId Int?

  // Session
  sessions UserSession[]
}

model UserSession {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @db.Text // ‚úÖ cho ph√©p chu·ªói d√†i
  createdAt Decimal? @db.Decimal(20, 3)

  user User @relation(fields: [userId], references: [id])
}

model TransferAdmin {
  id          Int            @id @default(autoincrement())
  user        User           @relation(fields: [userId], references: [id])
  userId      Int            @unique // üëà Th√™m d√≤ng n√†y
  fromUserId  Int
  toUserId    Int
  requestedAt Decimal        @db.Decimal(20, 3)
  approvedAt  Decimal?       @db.Decimal(20, 3)
  status      TransferStatus @default(PENDING)
}

enum TransferStatus {
  PENDING
  APPROVED
  REJECTED
}

model Flight {
  flightId           Int      @id @default(autoincrement())
  flightNo           String   @unique @db.VarChar(10) // ‚úÖ kh√¥ng cho tr√πng chuy·∫øn bay
  scheduledDeparture Decimal  @db.Decimal(20, 3)
  scheduledArrival   Decimal  @db.Decimal(20, 3)
  departureAirport   String   @db.VarChar(10)
  arrivalAirport     String   @db.VarChar(10)
  status             String   @db.VarChar(20)
  aircraftCode       String   @db.VarChar(10)
  actualDeparture    Decimal? @db.Decimal(20, 3)
  actualArrival      Decimal? @db.Decimal(20, 3)

  aircraft            Aircraft @relation(fields: [aircraftCode], references: [code])
  departureAirportRel Airport  @relation("DepartureRelation", fields: [departureAirport], references: [code])
  arrivalAirportRel   Airport  @relation("ArrivalRelation", fields: [arrivalAirport], references: [code])

  bookings       Booking[]
  meals          FlightMeal[]
  flightStatuses FlightStatus[]
}

model Aircraft {
  code    String   @id
  model   String
  range   Int
  flights Flight[]
}

model Airport {
  code        String @id
  name        String
  city        String
  coordinates String
  timezone    String

  departures Flight[] @relation("DepartureRelation")
  arrivals   Flight[] @relation("ArrivalRelation")
}

model Passenger {
  id       Int    @id @default(autoincrement())
  fullName String
  email    String @unique
  phone    String
  passport String

  bookings Booking[]
}

model Booking {
  id          Int     @id @default(autoincrement())
  passengerId Int
  flightId    Int
  seat        String
  bookingTime Decimal @db.Decimal(20, 3)

  passenger  Passenger   @relation(fields: [passengerId], references: [id])
  flight     Flight      @relation(fields: [flightId], references: [flightId])
  mealOrders MealOrder[]
}

model Meal {
  id          Int     @id @default(autoincrement())
  name        String
  mealType    String  @db.VarChar(50)
  description String?
  price       Float?
  isAvailable Boolean @default(true)

  flightMeals FlightMeal[]
  mealOrders  MealOrder[]
}

// {
//   "meals": [
//     { "id": 4, "quantity": 50, "price": 5.0 },
//     { "id": 2, "quantity": 30, "price": 4.5 }
//   ]
// }

model FlightMeal {
  id       Int    @id @default(autoincrement())
  flightId Int
  mealId   Int
  quantity Int    @default(1)
  price    Float?

  flight Flight @relation(fields: [flightId], references: [flightId])
  meal   Meal   @relation(fields: [mealId], references: [id])
}

model MealOrder {
  id        Int @id @default(autoincrement())
  bookingId Int
  mealId    Int
  quantity  Int @default(1)

  booking Booking @relation(fields: [bookingId], references: [id])
  meal    Meal    @relation(fields: [mealId], references: [id])
}

model FlightStatus {
  id          Int     @id @default(autoincrement())
  flightId    Int
  status      String  @db.VarChar(20)
  description String? @db.VarChar(255)
  updatedAt   Decimal @db.Decimal(20, 3)

  flight Flight @relation(fields: [flightId], references: [flightId])
}
